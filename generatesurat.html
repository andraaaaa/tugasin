<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.83.1">
    <title>Tugasin! Â· Buat Surat</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/dashboard/">

    

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" type="text/css" href="/static/dist/css/bootstrap.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>    
    <!-- Custom styles for this template -->
    <link href="/static/templates/dashboard/dashboard.css" type="text/css" rel="stylesheet">
		<link href="/static/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.22.1/docxtemplater.js"></script>
<script src="https://unpkg.com/pizzip@3.0.6/dist/pizzip.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
<script src="https://unpkg.com/pizzip@3.0.6/dist/pizzip-utils.js"></script>
<script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
<script src="/static/templates/sidebars/sidebars.js"></script>
<script src="/static/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/id.min.js"></script>

<link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

			.contain {
				width: 800px;
				margin: 0 auto;
			}
			h1 {
				margin: 40px 0 20px 0;
			}
			h2 {
				font-size: 1.5em;
				padding-bottom: 3px;
				border-bottom: 1px solid #DDD;
				margin-top: 50px;
				margin-bottom: 25px;
			}
			table th:first-child {
				width: 150px;
			}

      button:hover {
        background: rgb(71, 69, 69);
        color:rgb(236, 236, 236);
      }
		</style>
  </head>
  
  <body>
    
<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
  <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Tugasin!</a>
  <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <input class="form-control form-control-dark w-100" type="text" disabled>
  <ul class="navbar-nav px-3">
    <li class="nav-item text-nowrap">
      <a class="nav-link" href="#">Sign out</a>
    </li>
  </ul>
</header>

<div class="container-fluid">
  <div class="row">
    <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <div class="row g-3">
            <div class="col-sm-1"></div>
            <div class="col-sm-10">
              <center><a href="/addmitra"><button class="w-100 btn btn-primary" href="/generate" style="float:right;">Buat Surat Tugas Baru</button></a></center>
            </div>
            <div class="col-sm-1"></div>
          </div>
          </li>

          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="/dashboard">
              <span data-feather="home"></span>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/pegawai">
              <span data-feather="users"></span>
              Pegawai
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">
              <span data-feather="layers"></span>
              Rekapitulasi
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/setting">
              <span data-feather="settings"></span>
              Pengaturan
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="container" style="padding-left: 20%; padding-right: 20%;">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Buat Surat Tugas Baru</h1>
      </div>
      <form class="needs-validation" action="/send-data", method="POST" novalidate>
        <center><div class="row g-3">
          <div class="col-sm-6">
              <input type="radio" class="form-check-input" id="forkunj" name="tipe_surat" value="kunjungan" required>
              <label for="forkunj" class="form-check-label">Surat Tugas Kunjungan</label>
            </div>
            <div class="col-sm-6">
              <input type="radio" class="form-check-input" id="forspd" name="tipe_surat" value="spd" required>
              <label for="forspd" class="form-check-label">SPD</label>
            </div>
            <hr class="my-4">
            <div class="invalid-feedback">
              Silakan pilih jenis Surat Tugas terlebih dahulu!
            </div>
        </div></center>
        <label for="firstName" class="form-label">Nomor Surat Tugas (Terisi Otomatis)</label>
            <br/>
        <div class="row g-3">
          <div class="col-sm-2">
            <input type="text" class="form-control" id="nomorsurat" name="nomorsurat" placeholder="" value="" required>
            <script>
              $.getJSON('/static/json/ganttsurat.json', function(data){
                console.log(data);
                var len = data.length - 1;
                var latest_nomor = parseInt(data[len].nomorsurat) + 1;
                document.getElementById("nomorsurat").setAttribute("value", latest_nomor);
              })
              
            </script>
          </div>
          <div class="col-md-1">
            <button type="button" class="w-100 btn btn-secondary">
              <span data-feather="edit-2"></span>
            </button>
            <script>
              function edit(){
                var ed = document.getElementById("nomorsurat");
                ed.disabled = false;
              }
              

            </script>
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" id="previewnomor" name="nomorsuratfull" placeholder="" value="" readonly>  
          </div>
          
          <div class="col-md-2">
            <input class="datepicker" id="tanggalst" name="tanggalst" data-date-format="dd MMM yyyy">
                <script>
                  $('.datepicker').datepicker({
                    uiLibrary: 'bootstrap5'
                });
                </script>  
                <div class="invalid-feedback">
                  Silakan isi tanggal Surat Tugas
                </div>
          </div>

        </div>
        <br/>
        <div class="row g-3">
          <div class="col-5">
            <label for="pilihkf" class="form-label">Pemberi Surat Tugas (KF)</label>
                  <select class="form-select" id="pilihkf" name="kfsender" aria-label="Default select example" onchange="getKF()" required>
                    <option selected>-- Pilih KF --</option>
                    <script>
                      $(document).ready(function(){
                        $.get("/static/json/pegawai.json", function(data) {
            
                            data.forEach(dt => {
                              if(dt.iskf === 1){
                                $("#pilihkf").append(
                              "<option>"+ dt.nama + "</option>"
                              );
                              }
                            });
                        });
                      });
                    </script>
                </select>
            <div class="invalid-feedback">
              Silakan pilih KF terlebih dahulu
            </div>
          </div>
          
          <div class="col-5">
            <label for="username" class="form-label">Nama Surat Tugas</label>
            <select class="form-select" id="pilihpegawai" name="nama" aria-label="Default select example" onchange="getPegawai()" required>
              <option selected>-- Pilih Pegawai --</option>
              <script>
                function truncateOptions(){
                  var select = document.getElementById("pilihpegawai");
                  var length = select.options.length;
                  for (i = length-1; i > 0; i--) {
                    select.options[i] = null;
                  }
                }

                $(document).ready(function(){
                  $('input[type=radio][name=tipe]').change(function() {
                      if (this.value == 'pegawai') {
                        truncateOptions();
                        $.get("/static/json/pegawai.json", function(data) {   
                          data.forEach(dt => {
                              $("#pilihpegawai").append(
                              "<option>"+ dt.nama + "</option>"
                              );
                            });
                        });
                      }

                      else if (this.value == 'mitra') {
                        truncateOptions();  
                        $.get("/static/json/mitra.json", function(data) {
                            data = data["mitra"];

                              data.forEach(dt => {
                                  $("#pilihpegawai").append(
                                  "<option>"+ dt.nama + "</option>"
                                  );
                              });
                          });
                      }
                  });
                });

                function getPegawai(){  
                var peg = document.getElementById("pilihpegawai").value;
                $.getJSON("/static/json/pegawai.json", function(data){
                    for(var i=0; i < data.length; i++){
                        if(data[i].nama == peg){
                            document.getElementById("nip").innerHTML = data[i].nip;
                            document.getElementById("gol").innerHTML = data[i].golongan;
                            document.getElementById("jab").innerHTML = data[i].jabatan;
                            document.getElementById("pgkt").innerHTML = data[i].pangkat;
                        } else { continue; }
                    }   
                });
              }

              function getKF(){
                let t = new Date();
                var b = t.getMonth()+1;
                var y = t.getFullYear();
                var peg = document.getElementById("pilihkf").value;
                $.getJSON("/static/json/pegawai.json", function(data){
                    for(var i=0; i < data.length; i++){
                        if(data[i].nama == peg){
                            document.getElementById("jabkf").innerHTML = data[i].jabatan;
                            document.getElementById("kodeseksi").innerHTML = data[i].kode_seksi;
                            var nomor = document.getElementById("nomorsurat").value;
                            var ns = "B." + nomor + "/BPS/6401." + data[i].kode_seksi + "/SPD/" + b + "/" + y;
                            document.getElementById("previewnomor").setAttribute("value", ns);
                        } else { continue; }
                    }   
                });
              }

              (function h() {
                  'use strict'

                  // Fetch all the forms we want to apply custom Bootstrap validation styles to
                  var forms = document.querySelectorAll('.needs-validation')

                  // Loop over them and prevent submission
                  Array.prototype.slice.call(forms)
                    .forEach(function (form) {
                      form.addEventListener('submit', function (event) {
                        var namakf = document.getElementById("pilihkf").value;
                        var namapeg = document.getElementById("pilihpegawai").value;
                        if (!form.checkValidity() && namakf === "-- Pilih KF --" && namapeg === "-- Pilih Pegawai --") {
                          event.preventDefault()
                          event.stopPropagation()
                        }

                        form.classList.add('was-validated')
                      }, false)
                    })
                })()
              </script>
            </select>
          </div>
          <div class="col-2">
            <div class="space" style="padding-bottom: 25px;"></div>
            <input type="radio" class="form-check-input" id="formitra" name="tipe" value="mitra">
            <label for="formitra" class="form-check-label">Mitra</label>
            <br/>
            <input type="radio" class="form-check-input" id="forpeg" name="tipe" value="pegawai">
            <label for="jkp" class="form-check-label">Pegawai</label>
            <div class="space" style="padding-top: 10px;"></div>  
            <div class="invalid-feedback">
              Silakan isi jenis pegawai
            </div>
          </div>
        </div>
          <!--nama surat tugas -->
          <div class="space" style="width:30px;"></div>
          <!-- TUJUAN -->            
          <div class="row g-3">
            <div class="col-6">
              <label for="alamat" class="form-label">Tujuan</label>
              <input type="text" class="form-control" name="tujuan" id="alamat" placeholder="Desa Atau Kecamatan" required>
              <div class="invalid-feedback">
                Silakan isi tempat tujuan Surat Tugas
              </div>
            </div>
            <div class="col-6">
              <label for="alamat" class="form-label">Kegiatan</label>
              <input type="text" class="form-control" name="keg" id="kegiatan" placeholder="Tulis Kegiatan ..." required>
              <div class="invalid-feedback">
                Silakan isi kegiatan Surat Tugas
              </div>
            </div>
          </div>
          
        <br/>
                    
        <div class="row g-3">
          <label for="tanggal" class="form-label">Tanggal Pelaksanaan</label>
          <div class="col-md-6">
            
            <input class="datepicker2" name="startdate" id="mulaitanggal" data-date-format="dd MMM yyyy" required>
            <script>
              $('.datepicker2').datepicker({
                      uiLibrary: 'bootstrap5'
                });
            </script>
            <div class="invalid-feedback">
              Silakan isi tanggal awal pelaksanaan
            </div>
          </div>
          <div class="col-md-6" id="stcol" style="display:none;">
            <input class="datepicker3" name="finishdate" id="selesaitanggal" data-date-format="dd MMM yyyy">
            <script>
              $('.datepicker3').datepicker({
                    uiLibrary: 'bootstrap5'
                });
            </script>  
          </div>
        </div>

        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="multiday" onclick="var myinput = document.getElementById('stcol'); if(this.checked){myinput.style.display = 'block'; myinput.focus();} else {myinput.style.display = 'none';}"/>
          <label class="form-check-label" for="flexCheckChecked">
            Surat tugas lebih dari satu hari
          </label>
        </div>
        <hr class="my-4">
        <button type="submit" class="w-100 btn btn-primary">Buat Surat Tugas</button>        
      </form>
      
      <div id="nip" style="visibility:hidden"></div>
      <div id="pgkt" style="visibility:hidden"></div>
      <div id="gol" style="visibility:hidden"></div>
      <div id="jab" style="visibility:hidden"></div>
      <div id="jabkf" style="visibility:hidden"></div>
      <div id="asal" style="visibility: hidden;"></div>
      <div id="kodeseksi" style="visibility:hidden"></div>
    </div>
    </main>
  </div>
</div>

<script>

  function getSkrg(sym){
    var today = new Date();
    var dd = String(today.getDate()).padStart(2, '0');
    var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
    var yyyy = today.getFullYear();
    today = mm + sym + dd + sym + yyyy;
    return today;
  }

  function getDateCount(st, fin){
    var diffres;
    var d1 = new Date(st);
    var d2 = new Date(fin);
    var diff = Math.abs(d2-d1);
    if(diff === 0){
      diffres = 1
    } else diffres = diff;
    return diffres;
  }

  function loadFile(url,callback){
      PizZipUtils.getBinaryContent(url,callback);
  }

  function generate() {
      // VAR SURAT TUGAS DI SINI!!!
          
      let t = new Date();
          var namasurat = document.getElementById("pilihpegawai").value;
          var alamatsurat =  document.getElementById("alamat").value;
          var tglst = document.getElementById("tanggalst").value;
          var tglst_formatted = moment(tglst, 'MM/DD/YYYY', true).format('LL');
          var bln = t.getMonth()+1;
          var thn = t.getFullYear();
          var pg = document.getElementById("pgkt").innerHTML;
          var ns = document.getElementById("nomorsurat").value;
          var kf = document.getElementById("pilihkf").value;
          var jabkf = document.getElementById("jabkf").innerHTML;
          var nipsurat = document.getElementById("nip").innerHTML;
          var gol = document.getElementById("gol").innerHTML;
          var ks = document.getElementById("kodeseksi").innerHTML;
          var jab = document.getElementById("jab").innerHTML; 
          var keg =  document.getElementById("kegiatan").value;
          var tp = "";
          var balik; 
          var sd = document.getElementById("mulaitanggal").value;
          var sd_formatted = moment(sd, 'MM/DD/YYYY', true).format('LL');
          var multiday = document.getElementById("multiday").checked;
          console.log(multiday);
          var tgl = getSkrg('/');
          var dc = 1;
          console.log(tgl);
          
          var fd;
          if(multiday == false){
            tp = sd_formatted;
            balik = sd_formatted;
          } else {
            fd = document.getElementById("selesaitanggal").value;
              fd_formatted = moment(fd, 'MM/DD/YYYY', true).format('LL');
              tp = sd_formatted + " s.d. " + fd_formatted;
              balik = fd_formatted;
              dc = getDateCount(sd, fd);
          }

      loadFile("/static/surat/SURAT_TUGAS_2021.docx",function(error,content){
          if (error) { throw error };

          // The error object contains additional information when logged with JSON.stringify (it contains a properties object containing all suberrors).
          function replaceErrors(key, value) {
              if (value instanceof Error) {
                  return Object.getOwnPropertyNames(value).reduce(function(error, key) {
                      error[key] = value[key];
                      return error;
                  }, {});
              }
              return value;
          }
          const ts = new Date();
          console.log(ts)

          function errorHandler(error) {
              console.log(JSON.stringify({error: error}, replaceErrors));

              if (error.properties && error.properties.errors instanceof Array) {
                  const errorMessages = error.properties.errors.map(function (error) {
                      return error.properties.explanation;
                  }).join("\n");
                  console.log('errorMessages', errorMessages);
                  // errorMessages is a humanly readable message looking like this :
                  // 'The tag beginning with "foobar" is unopened'
              }
              throw error;
          }
          
          var zip = new PizZip(content);
          var doc;
          try {
              doc=new window.docxtemplater(zip);
          } catch(error) {
              // Catch compilation errors (errors caused by the compilation of the template : misplaced tags)
              errorHandler(error);
          }

              doc.setData({
                  timestamp: tgl,
                  kodesatker: ks,
                  kf_satker: kf,
                  jabatan_kf: jabkf,
                  tanggal_ST: tglst_formatted,
                  nomor_surat: ns,
                  bulan: bln,
                  tahun: thn,
                  nama: namasurat,
                  nip: nipsurat,
                  pangkat: pgkt,
                  golongan: gol,
                  jabatan: jab,
                  asal_petugas: "Kelurahan Tanah Grogot",
                  tujuan: alamatsurat,
                  kegiatan: keg,
                  tanggal_pelaksanaan: tp,
                  start_date: sd_formatted,
                  finish_date: balik,
                  date_count: Math.abs(1 + dc/86400000)
              });    
              
          try {
              // render the document (replace all occurences of {first_name} by John, {last_name} by Doe, ...)
              doc.render();
              
          }
          catch (error) {
              // Catch rendering errors (errors relating to the rendering of the template : angularParser throws an error)
              errorHandler(error);
          }

          var out=doc.getZip().generate({
              type:"blob",
              mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
          }) //Output the document using Data-URI

          var outst = "surattugas_" + getSkrg('_') + '_' + t.getHours() + t.getMinutes() + t.getSeconds() + ".docx"; 
          saveAs(out, outst);
      })
      
    }
  </script>

    <script src="/static/dist/js/bootstrap.bundle.min.js"></script>

      <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js" integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js" integrity="sha384-zNy6FEbO50N+Cg5wap8IKA4M/ZnLJgzc6w2NqACZaK0u0FXfOWRRJOnQtpZun8ha" crossorigin="anonymous"></script>
      <script src="/static/templates/dashboard/dashboard.js"></script>
      
  </body>
</html>
